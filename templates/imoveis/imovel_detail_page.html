{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ imovel.title }} - {{ block.super }}{% endblock %}

{% block styles %}
    {# Adicionamos o CSS do Leaflet para o mapa individual #}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .detail-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .detail-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Coluna da esquerda 2x maior que a da direita */
            gap: 2rem;
        }
        .main-photo {
            width: 100%;
            height: 450px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }
        .thumbnail-gallery {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .thumbnail-gallery img {
            width: 100px;
            height: 75px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 5px;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .thumbnail-gallery img:hover, .thumbnail-gallery img.active {
            border-color: var(--primary-color);
        }

        .info-col h1 {
            color: var(--primary-color);
            margin-top: 0;
            line-height: 1.2;
        }
        .info-col .address {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }
        .price-box {
            background-color: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        .price-box .main-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
        }
        .detail-section {
            margin-bottom: 1.5rem;
        }
        #individual-map {
            height: 250px;
            width: 100%;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="detail-grid">
        
        <div class="photo-col">
            <img id="main-photo" src="{{ imovel.fotos.0|default:'https://via.placeholder.com/800x600.png?text=Sem+Foto' }}" alt="{{ imovel.title }}" class="main-photo">
            {% if imovel.fotos|length > 1 %}
                <div class="thumbnail-gallery">
                    {% for foto_url in imovel.fotos %}
                        <img src="{{ foto_url }}" class="thumbnail" onclick="changeMainPhoto('{{ foto_url }}', this)">
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="info-col">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h1>{{ imovel.nome_condominio|default:imovel.title }}</h1>
                {% if user.is_authenticated %}
                    <span style="font-size: 1.5rem; margin-left: 1rem;">
                        {% include "imoveis/partials/favorito_icon.html" with imovel=imovel is_favorited=is_favorited %}
                    </span>
                {% endif %}
            </div>
            
            <p class="address">{{ imovel.address|default:"Endereço não informado" }}</p>

            <div class="price-box">
                <p style="margin: 0; font-size: 0.9rem; color: #666;">VALOR MÍNIMO DE VENDA</p>
                <p class="main-price">R$ {{ imovel.amount|intcomma }}</p>
                <small>Valor de Avaliação: R$ {{ imovel.valor_avaliacao|intcomma }}</small>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-info-circle"></i> Descrição</h4>
                <p>{{ imovel.descricao_detalhada|default:imovel.description|linebreaksbr }}</p>
            </div>
            
            <div class="detail-section">
                <h4><i class="fas fa-map-marker-alt"></i> Localização</h4>
                <div id="individual-map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- LÓGICA DA GALERIA DE FOTOS ---
    const mainPhoto = document.getElementById('main-photo');
    function changeMainPhoto(newSrc, thumbElement) {
        mainPhoto.src = newSrc;
        // Remove a classe 'active' de todas as thumbnails
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        // Adiciona a classe 'active' à thumbnail clicada
        thumbElement.classList.add('active');
    }

    // --- LÓGICA DO MAPA INDIVIDUAL ---
    // Verifica se temos coordenadas e o elemento do mapa antes de iniciar
    const mapDiv = document.getElementById('individual-map');
    const lat = {{ imovel.latitude|default:'null' }};
    const lng = {{ imovel.longitude|default:'null' }};

    if (mapDiv && lat && lng) {
        const map = L.map('individual-map').setView([lat, lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([lat, lng]).addTo(map)
            .bindPopup("{{ imovel.title|escapejs }}")
            .openPopup();
    }
</script>
{% endblock %}